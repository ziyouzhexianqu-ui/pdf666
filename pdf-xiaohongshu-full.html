<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFè½¬å°çº¢ä¹¦å›¾ç‰‡ç¼–è¾‘å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 6px;
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 20px;
            font-size: 13px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px;
        }

        .sidebar {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            height: fit-content;
            position: sticky;
            top: 16px;
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .canvas-area {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: 500px;
        }

        .section {
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            color: #ff6b6b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 2px;
        }

        .upload-area {
            border: 2px dashed #ffcece;
            border-radius: 10px;
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fffafa;
        }

        .upload-area:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 6px;
        }

        .upload-text {
            color: #888;
            font-size: 12px;
        }

        .upload-text strong {
            color: #ff6b6b;
        }

        input[type="file"] {
            display: none;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #444;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 50px;
        }

        .color-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        input[type="color"] {
            width: 36px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 2px;
        }

        .color-row input[type="text"] {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 9px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #555;
        }

        .btn-secondary:hover {
            background: #eee;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 6px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* å°ºå¯¸é¢„è®¾ */
        .size-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .size-preset {
            padding: 4px 9px;
            background: #f8f8f8;
            border: 1px solid #e8e8e8;
            border-radius: 15px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-preset:hover {
            border-color: #ff6b6b;
        }

        .size-preset.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .custom-size-row {
            display: none;
            gap: 6px;
            align-items: center;
            margin-top: 6px;
        }

        .custom-size-row.show {
            display: flex;
        }

        .custom-size-row input {
            width: 70px;
        }

        .custom-size-row span {
            color: #999;
            font-size: 12px;
        }

        /* å¸ƒå±€é€‰æ‹© */
        .layout-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .layout-item {
            aspect-ratio: 3/4;
            border: 2px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            background: #fafafa;
        }

        .layout-item:hover {
            border-color: #ff6b6b;
        }

        .layout-item.active {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .layout-preview {
            width: 100%;
            flex: 1;
            display: grid;
            gap: 1px;
        }

        .layout-preview div {
            background: #ff6b6b;
            border-radius: 1px;
            opacity: 0.5;
        }

        .layout-item.active .layout-preview div {
            opacity: 1;
        }

        .layout-label {
            font-size: 9px;
            color: #888;
            margin-top: 2px;
        }

        /* é¡µé¢ç½‘æ ¼ */
        .page-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-height: 160px;
            overflow-y: auto;
            padding: 2px;
        }

        .page-thumb {
            aspect-ratio: 3/4;
            border: 2px solid #eee;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: all 0.2s;
            background: #f5f5f5;
        }

        .page-thumb:hover {
            border-color: #ff9999;
        }

        .page-thumb.selected {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 2px rgba(255,107,107,0.25);
        }

        .page-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .page-num {
            position: absolute;
            bottom: 1px;
            right: 1px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 2px;
        }

        .page-order {
            position: absolute;
            top: 1px;
            left: 1px;
            background: #ff6b6b;
            color: white;
            font-size: 9px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* è¾“å‡ºåŒºåŸŸ */
        .output-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }

        .output-item {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .canvas-wrap {
            position: relative;
            display: inline-block;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            border-radius: 6px;
            overflow: hidden;
        }

        .output-canvas {
            display: block;
            max-height: 65vh;
            width: auto;
            cursor: crosshair;
        }

        .output-label {
            margin-top: 6px;
            font-size: 11px;
            color: #888;
        }

        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 350px;
            color: #bbb;
        }

        .placeholder-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        /* æ–‡å­—åˆ—è¡¨ */
        .text-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 6px;
        }

        .text-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 7px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .text-entry-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 6px;
        }

        .text-entry-btn {
            padding: 2px 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            background: #fee2e2;
            color: #dc2626;
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .range-row input[type="range"] {
            flex: 1;
        }

        .range-val {
            min-width: 38px;
            text-align: center;
            font-size: 11px;
            color: #666;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }

        .checkbox-row input {
            width: 14px;
            height: 14px;
        }

        /* æç¤ºæ¡† */
        .tip-box {
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
            padding: 8px 10px;
            border-radius: 0 6px 6px 0;
            font-size: 10px;
            color: #92400e;
            line-height: 1.5;
            margin-top: 10px;
        }

        /* ç¼–è¾‘æ¨¡å¼æŒ‡ç¤ºå™¨ */
        .edit-mode-bar {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: white;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(255,107,107,0.5);
            z-index: 100;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .edit-mode-bar.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.03); }
        }

        /* åŠ è½½é®ç½© */
        .loading-mask {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-mask.active {
            display: flex;
        }

        .loading-box {
            background: white;
            padding: 28px 44px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid #f0f0f0;
            border-top-color: #ff6b6b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 14px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-track {
            width: 180px;
            height: 5px;
            background: #eee;
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 3px;
            transition: width 0.3s;
        }

        @media (max-width: 960px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: static;
                max-height: none;
            }
        }

        /* æ­¥éª¤æŒ‡ç¤º */
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 24px;
            right: 24px;
            height: 2px;
            background: #eee;
            z-index: 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            position: relative;
            z-index: 1;
        }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #eee;
            color: #999;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.active .step-num {
            background: #ff6b6b;
            color: white;
        }

        .step.done .step-num {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 9px;
            color: #999;
        }

        .step.active .step-label,
        .step.done .step-label {
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“• PDF è½¬å°çº¢ä¹¦å›¾ç‰‡</h1>
        <p class="subtitle">ä¸Šä¼  PDF â†’ é€‰æ‹©å¸ƒå±€ â†’ æ‹¼æ¥é¡µé¢ â†’ æ·»åŠ æ–‡å­— â†’ å¯¼å‡ºå›¾ç‰‡</p>
        
        <div class="main-content">
            <div class="sidebar">
                <!-- æ­¥éª¤æŒ‡ç¤º -->
                <div class="steps">
                    <div class="step active" id="step1">
                        <div class="step-num">1</div>
                        <div class="step-label">ä¸Šä¼ </div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-num">2</div>
                        <div class="step-label">è®¾ç½®</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-num">3</div>
                        <div class="step-label">ç”Ÿæˆ</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-num">4</div>
                        <div class="step-label">æ–‡å­—</div>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-num">5</div>
                        <div class="step-label">å¯¼å‡º</div>
                    </div>
                </div>

                <!-- 1. ä¸Šä¼  PDF -->
                <div class="section" id="uploadSection">
                    <div class="section-title">â‘  ä¸Šä¼  PDF</div>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“„</div>
                        <div class="upload-text">æ‹–æ‹½æˆ–<strong>ç‚¹å‡»ä¸Šä¼ </strong></div>
                        <input type="file" id="fileInput" accept=".pdf">
                    </div>
                    <div id="fileInfo" style="margin-top:8px;font-size:11px;color:#666;display:none;"></div>
                </div>

                <!-- 2. å›¾ç‰‡å°ºå¯¸ -->
                <div class="section" id="sizeSection" style="display:none;">
                    <div class="section-title">â‘¡ å›¾ç‰‡å°ºå¯¸</div>
                    <div class="size-presets" id="sizePresets">
                        <span class="size-preset active" data-w="1242" data-h="1660">å°çº¢ä¹¦ç«–ç‰ˆ</span>
                        <span class="size-preset" data-w="1242" data-h="1242">å°çº¢ä¹¦æ–¹å½¢</span>
                        <span class="size-preset" data-w="1080" data-h="1920">æ‰‹æœºå£çº¸</span>
                        <span class="size-preset" data-w="0" data-h="0">è‡ªå®šä¹‰</span>
                    </div>
                    <div class="custom-size-row" id="customSizeRow">
                        <input type="number" id="customW" value="1242" min="100" max="5000">
                        <span>Ã—</span>
                        <input type="number" id="customH" value="1660" min="100" max="5000">
                        <span>px</span>
                    </div>
                </div>

                <!-- 3. é¡µé¢å¸ƒå±€ -->
                <div class="section" id="layoutSection" style="display:none;">
                    <div class="section-title">â‘¢ é¡µé¢å¸ƒå±€</div>
                    <div class="layout-grid" id="layoutGrid">
                        <div class="layout-item active" data-layout="1" data-cols="1" data-rows="1">
                            <div class="layout-preview" style="grid-template-columns:1fr;"><div></div></div>
                            <span class="layout-label">1é¡µ</span>
                        </div>
                        <div class="layout-item" data-layout="2" data-cols="1" data-rows="2">
                            <div class="layout-preview" style="grid-template-columns:1fr;grid-template-rows:1fr 1fr;"><div></div><div></div></div>
                            <span class="layout-label">2é¡µ</span>
                        </div>
                        <div class="layout-item" data-layout="3" data-cols="1" data-rows="3">
                            <div class="layout-preview" style="grid-template-columns:1fr;grid-template-rows:1fr 1fr 1fr;"><div></div><div></div><div></div></div>
                            <span class="layout-label">3é¡µ</span>
                        </div>
                        <div class="layout-item" data-layout="4" data-cols="2" data-rows="2">
                            <div class="layout-preview" style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;"><div></div><div></div><div></div><div></div></div>
                            <span class="layout-label">4é¡µ</span>
                        </div>
                        <div class="layout-item" data-layout="6" data-cols="2" data-rows="3">
                            <div class="layout-preview" style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr;"><div></div><div></div><div></div><div></div><div></div><div></div></div>
                            <span class="layout-label">6é¡µ</span>
                        </div>
                        <div class="layout-item" data-layout="9" data-cols="3" data-rows="3">
                            <div class="layout-preview" style="grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                            <span class="layout-label">9é¡µ</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:10px;">
                        <label>é¡µé¢é—´è·</label>
                        <div class="range-row">
                            <input type="range" id="gapRange" min="0" max="60" value="12">
                            <span class="range-val" id="gapVal">12px</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>èƒŒæ™¯é¢œè‰²</label>
                        <div class="color-row">
                            <input type="color" id="bgColorPicker" value="#ffffff">
                            <input type="text" id="bgColorText" value="#ffffff" maxlength="7">
                        </div>
                    </div>
                </div>

                <!-- 4. é€‰æ‹©é¡µé¢ -->
                <div class="section" id="pageSection" style="display:none;">
                    <div class="section-title">â‘£ é€‰æ‹©é¡µé¢ <span id="selCount">(0/0)</span></div>
                    <div class="btn-group" style="margin-bottom:8px;">
                        <button class="btn btn-secondary" id="selAllBtn">å…¨é€‰</button>
                        <button class="btn btn-secondary" id="clearSelBtn">æ¸…é™¤</button>
                    </div>
                    <div class="page-grid" id="pageGrid"></div>
                    <button class="btn btn-primary" id="generateBtn" style="margin-top:10px;" disabled>
                        ğŸ¨ ç”Ÿæˆæ‹¼æ¥å›¾ç‰‡
                    </button>
                </div>

                <!-- 5. æ·»åŠ æ–‡å­— -->
                <div class="section" id="textSection" style="display:none;">
                    <div class="section-title">â‘¤ æ·»åŠ æ–‡å­—</div>

                    <div class="form-group">
                        <label>ç›®æ ‡å›¾ç‰‡</label>
                        <select id="targetCanvas"></select>
                    </div>

                    <div class="form-group">
                        <label>æ–‡å­—å†…å®¹</label>
                        <textarea id="textInput" placeholder="è¾“å…¥æ–‡å­—å†…å®¹..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>å­—ä½“</label>
                        <select id="fontSelect">
                            <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                            <option value="SimHei">é»‘ä½“</option>
                            <option value="SimSun">å®‹ä½“</option>
                            <option value="KaiTi">æ¥·ä½“</option>
                            <option value="FangSong">ä»¿å®‹</option>
                            <option value="Arial">Arial</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Impact">Impact</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å­—å·</label>
                        <div class="range-row">
                            <input type="range" id="fontSizeRange" min="12" max="150" value="40">
                            <span class="range-val" id="fontSizeVal">40px</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ–‡å­—é¢œè‰²</label>
                        <div class="color-row">
                            <input type="color" id="fontColorPicker" value="#000000">
                            <input type="text" id="fontColorText" value="#000000" maxlength="7">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ–‡å­—èƒŒæ™¯</label>
                        <div class="color-row">
                            <input type="color" id="textBgColorPicker" value="#ffffff">
                            <input type="text" id="textBgColorText" value="#ffffff" maxlength="7">
                        </div>
                        <div class="checkbox-row" style="margin-top:4px;">
                            <input type="checkbox" id="enableTextBg">
                            <label for="enableTextBg">å¯ç”¨èƒŒæ™¯</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-row">
                            <input type="checkbox" id="boldCheck">
                            <label for="boldCheck">ç²—ä½“</label>
                        </div>
                        <div class="checkbox-row" style="margin-top:4px;">
                            <input type="checkbox" id="italicCheck">
                            <label for="italicCheck">æ–œä½“</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="addTextBtn">âœï¸ ç‚¹å‡»å›¾ç‰‡æ·»åŠ æ–‡å­—</button>

                    <div class="text-list" id="textList">
                        <div style="color:#aaa;font-size:10px;text-align:center;padding:10px;">æš‚æ— æ–‡å­—</div>
                    </div>

                    <button class="btn btn-secondary" id="clearTextBtn" style="margin-top:6px;">ğŸ—‘ï¸ æ¸…é™¤å½“å‰å›¾ç‰‡æ–‡å­—</button>
                </div>

                <!-- 6. å¯¼å‡º -->
                <div class="section" id="exportSection" style="display:none;">
                    <div class="section-title">â‘¥ å¯¼å‡ºå›¾ç‰‡</div>
                    <div class="btn-group">
                        <button class="btn btn-success" id="dlPngBtn">ğŸ“· PNG</button>
                        <button class="btn btn-success" id="dlJpgBtn">ğŸ–¼ï¸ JPG</button>
                    </div>
                    <button class="btn btn-secondary" id="resetBtn" style="margin-top:8px;">ğŸ”„ é‡æ–°å¼€å§‹</button>
                </div>

                <div class="tip-box">
                    ğŸ’¡ <strong>æ“ä½œæç¤º</strong><br>
                    â€¢ ç‚¹å‡»é¡µé¢ç¼©ç•¥å›¾é€‰æ‹©/å–æ¶ˆï¼Œæ•°å­—ä¸ºæ‹¼æ¥é¡ºåº<br>
                    â€¢ ç‚¹å‡»"æ·»åŠ æ–‡å­—"ååœ¨å›¾ç‰‡ä¸Šç‚¹å‡»æ”¾ç½®<br>
                    â€¢ å¯æ‹–åŠ¨å·²æ·»åŠ çš„æ–‡å­—è°ƒæ•´ä½ç½®
                </div>
            </div>

            <div class="canvas-area">
                <div class="placeholder" id="placeholder">
                    <div class="placeholder-icon">ğŸ“•</div>
                    <div>ä¸Šä¼  PDF æ–‡ä»¶å¼€å§‹åˆ¶ä½œ</div>
                </div>
                <div class="output-wrapper" id="outputWrapper"></div>
            </div>
        </div>
    </div>

    <div class="edit-mode-bar" id="editModeBar">âœï¸ ç‚¹å‡»å›¾ç‰‡æ”¾ç½®æ–‡å­— (ESC å–æ¶ˆ)</div>

    <div class="loading-mask" id="loadingMask">
        <div class="loading-box">
            <div class="spinner"></div>
            <div id="loadingMsg">å¤„ç†ä¸­...</div>
            <div class="progress-track">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ===== çŠ¶æ€ =====
        const S = {
            pdf: null,
            pages: [],           // æ‰€æœ‰é¡µé¢å›¾ç‰‡ dataURL
            selected: [],        // é€‰ä¸­çš„é¡µé¢ç´¢å¼•ï¼ˆæŒ‰é¡ºåºï¼‰
            outputW: 1242,
            outputH: 1660,
            layout: 1,
            layoutCols: 1,
            layoutRows: 1,
            gap: 12,
            bgColor: '#ffffff',
            canvases: [],        // ç”Ÿæˆçš„åŸå§‹ç”»å¸ƒ
            texts: [],           // [{idx, text, x, y, font, size, color, bold, italic, bg, enableBg}]
            isTextMode: false,
            dragging: null,
            dragOffset: { x: 0, y: 0 }
        };

        // ===== DOM =====
        const $ = id => document.getElementById(id);
        const D = {
            uploadArea: $('uploadArea'),
            fileInput: $('fileInput'),
            fileInfo: $('fileInfo'),
            sizeSection: $('sizeSection'),
            layoutSection: $('layoutSection'),
            pageSection: $('pageSection'),
            textSection: $('textSection'),
            exportSection: $('exportSection'),
            sizePresets: $('sizePresets'),
            customSizeRow: $('customSizeRow'),
            customW: $('customW'),
            customH: $('customH'),
            layoutGrid: $('layoutGrid'),
            gapRange: $('gapRange'),
            gapVal: $('gapVal'),
            bgColorPicker: $('bgColorPicker'),
            bgColorText: $('bgColorText'),
            pageGrid: $('pageGrid'),
            selCount: $('selCount'),
            generateBtn: $('generateBtn'),
            outputWrapper: $('outputWrapper'),
            placeholder: $('placeholder'),
            targetCanvas: $('targetCanvas'),
            textInput: $('textInput'),
            fontSelect: $('fontSelect'),
            fontSizeRange: $('fontSizeRange'),
            fontSizeVal: $('fontSizeVal'),
            fontColorPicker: $('fontColorPicker'),
            fontColorText: $('fontColorText'),
            textBgColorPicker: $('textBgColorPicker'),
            textBgColorText: $('textBgColorText'),
            enableTextBg: $('enableTextBg'),
            boldCheck: $('boldCheck'),
            italicCheck: $('italicCheck'),
            addTextBtn: $('addTextBtn'),
            textList: $('textList'),
            clearTextBtn: $('clearTextBtn'),
            editModeBar: $('editModeBar'),
            loadingMask: $('loadingMask'),
            loadingMsg: $('loadingMsg'),
            progressBar: $('progressBar')
        };

        // ===== åˆå§‹åŒ– =====
        function init() {
            // ä¸Šä¼ 
            D.uploadArea.onclick = () => D.fileInput.click();
            D.uploadArea.ondragover = e => { e.preventDefault(); D.uploadArea.style.borderColor = '#ff6b6b'; };
            D.uploadArea.ondragleave = e => { e.preventDefault(); D.uploadArea.style.borderColor = '#ffcece'; };
            D.uploadArea.ondrop = e => {
                e.preventDefault();
                D.uploadArea.style.borderColor = '#ffcece';
                const f = e.dataTransfer.files[0];
                if (f && f.type === 'application/pdf') loadPDF(f);
            };
            D.fileInput.onchange = e => e.target.files[0] && loadPDF(e.target.files[0]);

            // å°ºå¯¸é¢„è®¾
            D.sizePresets.querySelectorAll('.size-preset').forEach(btn => {
                btn.onclick = () => {
                    D.sizePresets.querySelectorAll('.size-preset').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const w = +btn.dataset.w, h = +btn.dataset.h;
                    if (w === 0) {
                        D.customSizeRow.classList.add('show');
                        S.outputW = +D.customW.value || 1242;
                        S.outputH = +D.customH.value || 1660;
                    } else {
                        D.customSizeRow.classList.remove('show');
                        S.outputW = w;
                        S.outputH = h;
                    }
                };
            });
            D.customW.oninput = () => S.outputW = +D.customW.value || 1242;
            D.customH.oninput = () => S.outputH = +D.customH.value || 1660;

            // å¸ƒå±€
            D.layoutGrid.querySelectorAll('.layout-item').forEach(item => {
                item.onclick = () => {
                    D.layoutGrid.querySelectorAll('.layout-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    S.layout = +item.dataset.layout;
                    S.layoutCols = +item.dataset.cols;
                    S.layoutRows = +item.dataset.rows;
                };
            });

            // é—´è·
            D.gapRange.oninput = () => {
                S.gap = +D.gapRange.value;
                D.gapVal.textContent = S.gap + 'px';
            };

            // èƒŒæ™¯è‰²
            D.bgColorPicker.oninput = () => {
                S.bgColor = D.bgColorPicker.value;
                D.bgColorText.value = S.bgColor;
            };
            D.bgColorText.oninput = () => {
                if (/^#[0-9A-Fa-f]{6}$/.test(D.bgColorText.value)) {
                    D.bgColorPicker.value = D.bgColorText.value;
                    S.bgColor = D.bgColorText.value;
                }
            };

            // é¡µé¢é€‰æ‹©
            $('selAllBtn').onclick = () => {
                S.selected = S.pages.map((_, i) => i);
                renderPageGrid();
            };
            $('clearSelBtn').onclick = () => {
                S.selected = [];
                renderPageGrid();
            };

            // ç”Ÿæˆ
            D.generateBtn.onclick = generateOutput;

            // æ–‡å­—é¢œè‰²
            D.fontSizeRange.oninput = () => D.fontSizeVal.textContent = D.fontSizeRange.value + 'px';
            D.fontColorPicker.oninput = () => D.fontColorText.value = D.fontColorPicker.value;
            D.fontColorText.oninput = () => {
                if (/^#[0-9A-Fa-f]{6}$/.test(D.fontColorText.value)) D.fontColorPicker.value = D.fontColorText.value;
            };
            D.textBgColorPicker.oninput = () => D.textBgColorText.value = D.textBgColorPicker.value;
            D.textBgColorText.oninput = () => {
                if (/^#[0-9A-Fa-f]{6}$/.test(D.textBgColorText.value)) D.textBgColorPicker.value = D.textBgColorText.value;
            };

            // æ·»åŠ æ–‡å­—æ¨¡å¼
            D.addTextBtn.onclick = toggleTextMode;

            // æ¸…é™¤æ–‡å­—
            D.clearTextBtn.onclick = () => {
                const idx = +D.targetCanvas.value;
                S.texts = S.texts.filter(t => t.idx !== idx);
                redrawCanvas(idx);
                renderTextList();
            };

            // å¯¼å‡º
            $('dlPngBtn').onclick = () => downloadAll('png');
            $('dlJpgBtn').onclick = () => downloadAll('jpeg');
            $('resetBtn').onclick = resetAll;

            // ESC å–æ¶ˆæ–‡å­—æ¨¡å¼
            document.onkeydown = e => {
                if (e.key === 'Escape' && S.isTextMode) toggleTextMode();
            };
        }

        // ===== åŠ è½½ PDF =====
        async function loadPDF(file) {
            showLoading(true, 'åŠ è½½ PDF...');
            try {
                const data = await file.arrayBuffer();
                S.pdf = await pdfjsLib.getDocument({ data }).promise;
                S.pages = [];
                S.selected = [];
                S.canvases = [];
                S.texts = [];

                const total = S.pdf.numPages;
                for (let i = 1; i <= total; i++) {
                    setProgress((i / total) * 100, `æ¸²æŸ“ç¬¬ ${i}/${total} é¡µ`);
                    const page = await S.pdf.getPage(i);
                    const vp = page.getViewport({ scale: 2 });
                    const cvs = document.createElement('canvas');
                    cvs.width = vp.width;
                    cvs.height = vp.height;
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                    S.pages.push(cvs.toDataURL('image/png'));
                }

                D.fileInfo.style.display = 'block';
                D.fileInfo.textContent = `âœ… ${file.name} (${total} é¡µ)`;

                D.sizeSection.style.display = 'block';
                D.layoutSection.style.display = 'block';
                D.pageSection.style.display = 'block';
                D.placeholder.style.display = 'none';

                setStep(2);
                renderPageGrid();
            } catch (err) {
                console.error(err);
                alert('PDF åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶');
            }
            showLoading(false);
        }

        // ===== æ¸²æŸ“é¡µé¢ç½‘æ ¼ =====
        function renderPageGrid() {
            D.pageGrid.innerHTML = S.pages.map((src, i) => {
                const order = S.selected.indexOf(i);
                return `
                    <div class="page-thumb ${order > -1 ? 'selected' : ''}" data-i="${i}">
                        <img src="${src}" alt="Page ${i+1}">
                        <span class="page-num">${i + 1}</span>
                        ${order > -1 ? `<span class="page-order">${order + 1}</span>` : ''}
                    </div>
                `;
            }).join('');

            D.pageGrid.querySelectorAll('.page-thumb').forEach(el => {
                el.onclick = () => {
                    const i = +el.dataset.i;
                    const pos = S.selected.indexOf(i);
                    if (pos > -1) S.selected.splice(pos, 1);
                    else S.selected.push(i);
                    renderPageGrid();
                };
            });

            D.selCount.textContent = `(${S.selected.length}/${S.pages.length})`;
            D.generateBtn.disabled = S.selected.length === 0;
        }

        // ===== ç”Ÿæˆè¾“å‡ºå›¾ç‰‡ =====
        async function generateOutput() {
            if (S.selected.length === 0) return alert('è¯·é€‰æ‹©é¡µé¢');

            showLoading(true, 'ç”Ÿæˆå›¾ç‰‡...');
            S.canvases = [];
            S.texts = [];
            D.outputWrapper.innerHTML = '';

            const { layout, layoutCols: cols, layoutRows: rows, gap, outputW: W, outputH: H, bgColor } = S;
            const cellW = (W - gap * (cols + 1)) / cols;
            const cellH = (H - gap * (rows + 1)) / rows;

            const selectedSrcs = S.selected.map(i => S.pages[i]);
            const totalOutputs = Math.ceil(selectedSrcs.length / layout);

            for (let outIdx = 0; outIdx < totalOutputs; outIdx++) {
                setProgress(((outIdx + 1) / totalOutputs) * 100);

                const cvs = document.createElement('canvas');
                cvs.width = W;
                cvs.height = H;
                const ctx = cvs.getContext('2d');

                // èƒŒæ™¯
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, W, H);

                // ç»˜åˆ¶é¡µé¢
                for (let slot = 0; slot < layout; slot++) {
                    const pageIdx = outIdx * layout + slot;
                    if (pageIdx >= selectedSrcs.length) break;

                    const col = slot % cols;
                    const row = Math.floor(slot / cols);
                    const x = gap + col * (cellW + gap);
                    const y = gap + row * (cellH + gap);

                    const img = await loadImg(selectedSrcs[pageIdx]);
                    const scale = Math.min(cellW / img.width, cellH / img.height);
                    const dw = img.width * scale;
                    const dh = img.height * scale;
                    const dx = x + (cellW - dw) / 2;
                    const dy = y + (cellH - dh) / 2;

                    ctx.drawImage(img, dx, dy, dw, dh);
                }

                S.canvases.push(cvs);

                // åˆ›å»ºæ˜¾ç¤ºå…ƒç´ 
                const wrap = document.createElement('div');
                wrap.className = 'output-item';
                wrap.innerHTML = `
                    <div class="canvas-wrap">
                        <canvas class="output-canvas" data-idx="${outIdx}" width="${W}" height="${H}"></canvas>
                    </div>
                    <div class="output-label">å›¾ç‰‡ ${outIdx + 1} / ${totalOutputs}</div>
                `;
                D.outputWrapper.appendChild(wrap);

                const displayCvs = wrap.querySelector('canvas');
                displayCvs.getContext('2d').drawImage(cvs, 0, 0);

                // äº‹ä»¶
                displayCvs.onclick = e => handleCanvasClick(e, outIdx);
                displayCvs.onmousedown = e => handleMouseDown(e, outIdx);
                displayCvs.onmousemove = e => handleMouseMove(e, outIdx);
                displayCvs.onmouseup = handleMouseUp;
                displayCvs.onmouseleave = handleMouseUp;
            }

            // æ›´æ–°ç›®æ ‡é€‰æ‹©
            D.targetCanvas.innerHTML = S.canvases.map((_, i) => `<option value="${i}">å›¾ç‰‡ ${i + 1}</option>`).join('');

            D.textSection.style.display = 'block';
            D.exportSection.style.display = 'block';
            setStep(4);
            showLoading(false);
        }

        // ===== æ–‡å­—æ¨¡å¼ =====
        function toggleTextMode() {
            S.isTextMode = !S.isTextMode;
            D.editModeBar.classList.toggle('active', S.isTextMode);
            D.addTextBtn.textContent = S.isTextMode ? 'âŒ å–æ¶ˆæ·»åŠ ' : 'âœï¸ ç‚¹å‡»å›¾ç‰‡æ·»åŠ æ–‡å­—';

            D.outputWrapper.querySelectorAll('.output-canvas').forEach(c => {
                c.style.cursor = S.isTextMode ? 'crosshair' : 'default';
            });
        }

        // ===== ç”»å¸ƒç‚¹å‡» =====
        function handleCanvasClick(e, idx) {
            if (!S.isTextMode) return;

            const text = D.textInput.value.trim();
            if (!text) return alert('è¯·è¾“å…¥æ–‡å­—å†…å®¹');

            const cvs = e.target;
            const rect = cvs.getBoundingClientRect();
            const scaleX = cvs.width / rect.width;
            const scaleY = cvs.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            S.texts.push({
                idx,
                text,
                x,
                y,
                font: D.fontSelect.value,
                size: +D.fontSizeRange.value,
                color: D.fontColorPicker.value,
                bold: D.boldCheck.checked,
                italic: D.italicCheck.checked,
                bg: D.textBgColorPicker.value,
                enableBg: D.enableTextBg.checked
            });

            redrawCanvas(idx);
            renderTextList();
            toggleTextMode();
        }

        // ===== æ‹–åŠ¨æ–‡å­— =====
        function handleMouseDown(e, idx) {
            if (S.isTextMode) return;

            const cvs = e.target;
            const rect = cvs.getBoundingClientRect();
            const scaleX = cvs.width / rect.width;
            const scaleY = cvs.height / rect.height;
            const mx = (e.clientX - rect.left) * scaleX;
            const my = (e.clientY - rect.top) * scaleY;

            // æŸ¥æ‰¾ç‚¹å‡»çš„æ–‡å­—ï¼ˆä»åå¾€å‰ï¼‰
            const canvasTexts = S.texts.filter(t => t.idx === idx);
            for (let i = canvasTexts.length - 1; i >= 0; i--) {
                const t = canvasTexts[i];
                if (t.bounds && isInBounds(mx, my, t.bounds)) {
                    S.dragging = t;
                    S.dragOffset = { x: mx - t.x, y: my - t.y };
                    cvs.style.cursor = 'move';
                    return;
                }
            }
        }

        function handleMouseMove(e, idx) {
            if (!S.dragging || S.dragging.idx !== idx) return;

            const cvs = e.target;
            const rect = cvs.getBoundingClientRect();
            const scaleX = cvs.width / rect.width;
            const scaleY = cvs.height / rect.height;
            const mx = (e.clientX - rect.left) * scaleX;
            const my = (e.clientY - rect.top) * scaleY;

            S.dragging.x = mx - S.dragOffset.x;
            S.dragging.y = my - S.dragOffset.y;
            redrawCanvas(idx);
        }

        function handleMouseUp(e) {
            if (S.dragging) {
                e.target.style.cursor = S.isTextMode ? 'crosshair' : 'default';
                S.dragging = null;
            }
        }

        function isInBounds(x, y, b) {
            return x >= b.x && x <= b.x + b.w && y >= b.y && y <= b.y + b.h;
        }

        // ===== é‡ç»˜ç”»å¸ƒ =====
        function redrawCanvas(idx) {
            const srcCvs = S.canvases[idx];
            const displayCvs = D.outputWrapper.querySelectorAll('.output-canvas')[idx];
            const ctx = displayCvs.getContext('2d');

            ctx.clearRect(0, 0, displayCvs.width, displayCvs.height);
            ctx.drawImage(srcCvs, 0, 0);

            S.texts.filter(t => t.idx === idx).forEach(t => {
                drawText(ctx, t);
            });
        }

        // ===== ç»˜åˆ¶æ–‡å­— =====
        function drawText(ctx, t) {
            const fontStr = `${t.italic ? 'italic ' : ''}${t.bold ? 'bold ' : ''}${t.size}px "${t.font}"`;
            ctx.font = fontStr;

            const lines = t.text.split('\n');
            const lineH = t.size * 1.25;

            let maxW = 0;
            lines.forEach(line => {
                const w = ctx.measureText(line).width;
                if (w > maxW) maxW = w;
            });

            const totalH = lines.length * lineH;
            const padding = 6;

            // ä¿å­˜è¾¹ç•Œç”¨äºæ‹–åŠ¨
            t.bounds = {
                x: t.x - padding,
                y: t.y - t.size - padding,
                w: maxW + padding * 2,
                h: totalH + padding * 2
            };

            // èƒŒæ™¯
            if (t.enableBg) {
                ctx.fillStyle = t.bg;
                ctx.fillRect(t.bounds.x, t.bounds.y, t.bounds.w, t.bounds.h);
            }

            // æ–‡å­—
            ctx.fillStyle = t.color;
            ctx.font = fontStr;
            lines.forEach((line, i) => {
                ctx.fillText(line, t.x, t.y + i * lineH);
            });
        }

        // ===== æ¸²æŸ“æ–‡å­—åˆ—è¡¨ =====
        function renderTextList() {
            const idx = +D.targetCanvas.value;
            const list = S.texts.filter(t => t.idx === idx);

            if (list.length === 0) {
                D.textList.innerHTML = '<div style="color:#aaa;font-size:10px;text-align:center;padding:10px;">æš‚æ— æ–‡å­—</div>';
                return;
            }

            D.textList.innerHTML = list.map((t, i) => {
                const globalIdx = S.texts.indexOf(t);
                const preview = t.text.length > 12 ? t.text.substring(0, 12) + '...' : t.text;
                return `
                    <div class="text-entry">
                        <span class="text-entry-content" style="color:${t.color};font-family:${t.font};">${preview}</span>
                        <button class="text-entry-btn" onclick="deleteText(${globalIdx})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        // ç›®æ ‡ç”»å¸ƒåˆ‡æ¢æ—¶æ›´æ–°åˆ—è¡¨
        D.targetCanvas.onchange = renderTextList;

        // ===== åˆ é™¤æ–‡å­— =====
        window.deleteText = function(globalIdx) {
            const t = S.texts[globalIdx];
            const idx = t.idx;
            S.texts.splice(globalIdx, 1);
            redrawCanvas(idx);
            renderTextList();
        };

        // ===== ä¸‹è½½ =====
        function downloadAll(format) {
            S.canvases.forEach((srcCvs, idx) => {
                const finalCvs = document.createElement('canvas');
                finalCvs.width = srcCvs.width;
                finalCvs.height = srcCvs.height;
                const ctx = finalCvs.getContext('2d');

                // JPG éœ€è¦ç™½è‰²èƒŒæ™¯
                if (format === 'jpeg') {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, finalCvs.width, finalCvs.height);
                }

                ctx.drawImage(srcCvs, 0, 0);

                // ç»˜åˆ¶æ–‡å­—
                S.texts.filter(t => t.idx === idx).forEach(t => drawText(ctx, t));

                const link = document.createElement('a');
                link.download = `xiaohongshu_${idx + 1}.${format === 'jpeg' ? 'jpg' : 'png'}`;
                link.href = finalCvs.toDataURL(`image/${format}`, 0.95);
                link.click();
            });

            setStep(5);
        }

        // ===== é‡ç½® =====
        function resetAll() {
            S.pdf = null;
            S.pages = [];
            S.selected = [];
            S.canvases = [];
            S.texts = [];
            S.isTextMode = false;
            S.dragging = null;

            D.fileInput.value = '';
            D.fileInfo.style.display = 'none';
            D.sizeSection.style.display = 'none';
            D.layoutSection.style.display = 'none';
            D.pageSection.style.display = 'none';
            D.textSection.style.display = 'none';
            D.exportSection.style.display = 'none';
            D.placeholder.style.display = 'flex';
            D.outputWrapper.innerHTML = '';
            D.editModeBar.classList.remove('active');
            D.textList.innerHTML = '<div style="color:#aaa;font-size:10px;text-align:center;padding:10px;">æš‚æ— æ–‡å­—</div>';

            setStep(1);
        }

        // ===== å·¥å…·å‡½æ•° =====
        function loadImg(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = src;
            });
        }

        function showLoading(show, msg = 'å¤„ç†ä¸­...') {
            D.loadingMask.classList.toggle('active', show);
            D.loadingMsg.textContent = msg;
            if (!show) D.progressBar.style.width = '0%';
        }

        function setProgress(pct, msg) {
            D.progressBar.style.width = pct + '%';
            if (msg) D.loadingMsg.textContent = msg;
        }

        function setStep(n) {
            for (let i = 1; i <= 5; i++) {
                const el = $('step' + i);
                el.classList.remove('active', 'done');
                if (i < n) el.classList.add('done');
                else if (i === n) el.classList.add('active');
            }
        }

        // ===== å¯åŠ¨ =====
        init();
    </script>
</body>
</html>
